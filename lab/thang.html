<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>ArcGIS JavaScript Tutorials: Th·∫Øng Map Application</title>
    <style>
        html,
        body,
        #viewDiv {
            padding: 0;
            margin: 0;
            height: 100%;
            width: 100%;
        }

        /* CSS cho panel ƒëi·ªÅu khi·ªÉn */
        #controlPanel {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            max-width: 300px;
            z-index: 100;
            font-family: Arial, sans-serif;
        }

        #clearButton {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 10px;
            font-size: 14px;
        }

        #clearButton:hover {
            background: #c82333;
        }

        #coordinateOutput {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre;
        }

        .control-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
    </style>

    <link rel="stylesheet" href="https://js.arcgis.com/4.26/esri/themes/light/main.css">
    <script src="https://js.arcgis.com/4.26/"></script>

    <script>
        // ========== COMMON POPUP TEMPLATES ==========
        var point_template_tree = {
            title: "{Name}",
            content: "C√¢y n√†y ·ªü <b>{Location}</b>."
        };

        var point_template_light = {
            title: "{Name}",
            content: "B√≥ng ƒë√®n n√†y ·ªü <b>{Location}</b>."
        };

        var point_template_chair = {
            title: "{Name}",
            content: "C√°i gh·∫ø n√†y ·ªü <b>{Location}</b>."
        };

        var point_template_area = {
            title: "{Name}",
            content: "Khu v·ª±c n√†y ·ªü <b>{Location}</b>."
        };

        var point_template_university = {
            title: "{Name}",
            content: "Tr∆∞·ªùng ·ªü <b>{Location}</b>."
        };

        // ========== COMMON TEMPLATE FOR FEATURES ==========
        var templatePopup = {
            title: "{Name}",
            content: "{Description}"
        };

        // ========== S√ÇN T·∫¨P GOLF DATA ==========
        var jsondata = {
            "type": "FeatureCollection",
            "features": [
                {
                    "type": "Feature",
                    "properties": {
                        "name": "ƒê∆∞·ªùng ranh gi·ªõi S√¢n t·∫≠p Golf",
                        "description": "ƒê∆∞·ªùng ranh gi·ªõi khu v·ª±c s√¢n t·∫≠p golf"
                    },
                    "geometry": {
                        "coordinates": [
                            [106.640615, 10.808255],
                            [106.641485, 10.808130],
                            [106.641545, 10.808081],
                            [106.641556, 10.808001],
                            [106.641523, 10.807226],
                            [106.640373, 10.807370],
                            [106.640254, 10.807716],
                            [106.640274, 10.807984],
                            [106.640447, 10.808185],
                            [106.640534, 10.808243],
                            [106.640615, 10.808255]
                        ],
                        "type": "LineString"
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "name": "S√¢n t·∫≠p Golf",
                        "address": "Khu v·ª±c s√¢n t·∫≠p golf, TP.HCM",
                        "type": "S√¢n t·∫≠p th·ªÉ thao",
                        "established": "2020",
                        "area": "Khu v·ª±c t·∫≠p luy·ªán golf chuy√™n nghi·ªáp"
                    },
                    "geometry": {
                        "type": "Polygon",
                        "symbol": {
                            "type": "simple-fill",
                            "color": [130, 200, 80, 0.4],
                            "outline": {
                                "color": [90, 140, 50],
                                "width": 2
                            }
                        },
                        "coordinates": [
                            [
                                [106.640615, 10.808255],
                                [106.641485, 10.808130],
                                [106.641545, 10.808081],
                                [106.641556, 10.808001],
                                [106.641523, 10.807226],
                                [106.640373, 10.807370],
                                [106.640254, 10.807716],
                                [106.640274, 10.807984],
                                [106.640447, 10.808185],
                                [106.640534, 10.808243],
                                [106.640615, 10.808255]
                            ]
                        ]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "name": "S√¢n t·∫≠p Golf",
                        "type": "S√¢n t·∫≠p th·ªÉ thao",
                        "description": "S√¢n t·∫≠p golf chuy√™n nghi·ªáp v·ªõi ƒë·∫ßy ƒë·ªß ti·ªán nghi v√† thi·∫øt b·ªã hi·ªán ƒë·∫°i. Ph·ª•c v·ª• cho vi·ªác luy·ªán t·∫≠p v√† gi·∫£i tr√≠."
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [106.640945, 10.807723]
                    }
                }
            ]
        };

        require([
            "esri/Map",
            "esri/views/MapView",
            "esri/Graphic",
            "esri/layers/GraphicsLayer"
        ], function (Map, MapView, Graphic, GraphicsLayer) {

            // ========== MAP INITIALIZATION ==========
            var map = new Map({
                basemap: "topo-vector"
            });

            map.on("load", function () {
                map.graphics.enableMouseEvents();
            });

            var view = new MapView({
                container: "viewDiv",
                map: map,
                center: [106.640945, 10.807723], // T·ªça ƒë·ªô trung t√¢m S√¢n t·∫≠p Golf
                zoom: 18,
                highlightOptions: {
                    color: "blue"
                }
            });

            var graphicsLayer = new GraphicsLayer();

            // ========== COMMON SYMBOLS ==========
            var lineSymbol = {
                type: "simple-line",
                color: [255, 87, 34], // M√†u cam ƒë·ªè
                width: 3,
                style: "solid"
            };

            var polygonSymbol = {
                type: "simple-fill",
                color: [130, 200, 80, 0.4], // M√†u xanh l√° cho s√¢n golf
                outline: {
                    color: [90, 140, 50],
                    width: 2
                }
            };

            // Symbol ƒë·∫∑c bi·ªát
            var specialPolygonSymbol = {
                type: "simple-fill",
                color: [67, 162, 202, 0.3],
                outline: {
                    color: [41, 98, 155],
                    width: 3,
                    style: "dash"
                }
            };

            // ========== CONFIGURABLE POINT SYMBOLS ==========
            // Icon m·∫∑c ƒë·ªãnh - golf course
            var pointSymbol = {
                type: "picture-marker",
                url: "https://cdn-icons-png.flaticon.com/512/2514/2514078.png", // Icon golf t·ª´ attachment
                width: "56px",
                height: "56px"
            };

            // ========== ALTERNATIVE ICONS ==========
            var iconLibrary = {
                golf: "https://cdn-icons-png.flaticon.com/512/2514/2514078.png",
                golfFlag: "https://cdn-icons-png.flaticon.com/512/2972/2972472.png",
                location: "https://cdn-icons-png.flaticon.com/512/684/684908.png",
                building: "https://cdn-icons-png.flaticon.com/512/2830/2830284.png",
                school: "https://cdn-icons-png.flaticon.com/512/3595/3595030.png",
                hospital: "https://cdn-icons-png.flaticon.com/512/3063/3063135.png",
                park: "https://cdn-icons-png.flaticon.com/512/532/532988.png",
                stadium: "https://cdn-icons-png.flaticon.com/512/5540/5540420.png",
                airport: "https://static.arcgis.com/images/Symbols/Transportation/Airplane.png",
                restaurant: "https://cdn-icons-png.flaticon.com/512/685/685352.png"
            };

            // ========== COMMON FEATURE PROCESSING LOGIC ==========
            jsondata.features.forEach(function (feature) {
                var geometry;
                var symbol;
                var popupTemplate;

                if (feature.geometry.type === "LineString") {
                    // X·ª≠ l√Ω ƒë∆∞·ªùng ranh gi·ªõi
                    geometry = {
                        type: "polyline",
                        paths: [feature.geometry.coordinates]
                    };
                    symbol = lineSymbol;
                    popupTemplate = {
                        title: feature.properties.name,
                        content: "<b>M√¥ t·∫£:</b> {description}<br/><b>Lo·∫°i:</b> ƒê∆∞·ªùng ranh gi·ªõi"
                    };

                    var lineGraphic = new Graphic({
                        geometry: geometry,
                        symbol: symbol,
                        attributes: feature.properties,
                        popupTemplate: popupTemplate
                    });
                    graphicsLayer.add(lineGraphic);

                    // T·∫°o v√πng fill t·ª´ ƒë∆∞·ªùng ranh gi·ªõi
                    var polygonGeometry = {
                        type: "polygon",
                        rings: [feature.geometry.coordinates]
                    };

                    var polygonFill = {
                        type: "simple-fill",
                        color: [255, 193, 7, 0.4], // M√†u v√†ng v·ªõi ƒë·ªô trong su·ªët 40%
                        outline: {
                            color: [255, 152, 0],
                            width: 2
                        }
                    };

                    var polygonGraphic = new Graphic({
                        geometry: polygonGeometry,
                        symbol: polygonFill,
                        attributes: { name: feature.properties.name + " (fill)" },
                        popupTemplate: {
                            title: feature.properties.name,
                            content: "ƒê√¢y l√† v√πng ƒë∆∞·ª£c fill t·ª´ ƒë∆∞·ªùng ranh gi·ªõi."
                        }
                    });

                    graphicsLayer.add(polygonGraphic);
                    return;

                } else if (feature.geometry.type === "Polygon") {
                    // X·ª≠ l√Ω v√πng polygon
                    geometry = {
                        type: "polygon",
                        rings: feature.geometry.coordinates
                    };
                    symbol = polygonSymbol;
                    popupTemplate = {
                        title: feature.properties.name,
                        content: `
                            <div style="font-family: Arial, sans-serif;">
                                <p><b>üìç ƒê·ªãa ch·ªâ:</b> {address}</p>
                                <p><b>üèõÔ∏è Lo·∫°i:</b> {type}</p>
                                <p><b>üìÖ Th√†nh l·∫≠p:</b> {established}</p>
                                <p><b>üó∫Ô∏è Khu v·ª±c:</b> {area}</p>
                                <p><b>‚ÑπÔ∏è M√¥ t·∫£:</b> Khu v·ª±c ƒë∆∞·ª£c ƒë√°nh d·∫•u tr√™n b·∫£n ƒë·ªì</p>
                            </div>
                        `
                    };

                } else if (feature.geometry.type === "Point") {
                    // X·ª≠ l√Ω ƒëi·ªÉm v·ªõi icon
                    geometry = {
                        type: "point",
                        longitude: feature.geometry.coordinates[0],
                        latitude: feature.geometry.coordinates[1]
                    };
                    symbol = pointSymbol;
                    popupTemplate = {
                        title: feature.properties.name,
                        content: `
                            <div style="font-family: Arial, sans-serif; text-align: center;">
                                <p><b>üìç {type}</b></p>
                                <p>{description}</p>
                                <p style="color: #1976D2;"><b>T·ªça ƒë·ªô:</b><br/>
                                Kinh ƒë·ªô: ${feature.geometry.coordinates[0].toFixed(6)}<br/>
                                Vƒ© ƒë·ªô: ${feature.geometry.coordinates[1].toFixed(6)}</p>
                            </div>
                        `
                    };
                }

                var graphic = new Graphic({
                    geometry: geometry,
                    symbol: symbol,
                    attributes: feature.properties,
                    popupTemplate: popupTemplate
                });
                graphicsLayer.add(graphic);
            });

            map.add(graphicsLayer);

            // ========== CLICK COORDINATE FUNCTIONALITY ==========
            // Khai b√°o m·∫£ng ƒë·ªÉ l∆∞u tr·ªØ c√°c t·ªça ƒë·ªô ƒë∆∞·ª£c click
            var clickedCoordinates = [];
            var clickedGraphics = []; // ƒê·ªÉ l∆∞u tr·ªØ c√°c graphic ƒëi·ªÉm ƒë√£ click
            var clickGraphicsLayer = new GraphicsLayer(); // Layer ri√™ng cho c√°c ƒëi·ªÉm click
            map.add(clickGraphicsLayer); // Th√™m layer ri√™ng cho c√°c ƒëi·ªÉm click v√†o b·∫£n ƒë·ªì

            // --- X·ª≠ l√Ω s·ª± ki·ªán click tr√™n b·∫£n ƒë·ªì ---
            view.on("click", function (event) {
                var latitude = parseFloat(event.mapPoint.latitude.toFixed(6));
                var longitude = parseFloat(event.mapPoint.longitude.toFixed(6));
                var newCoordinate = [longitude, latitude]; // ƒê·ªãnh d·∫°ng [kinh ƒë·ªô, vƒ© ƒë·ªô]

                clickedCoordinates.push(newCoordinate); // Th√™m t·ªça ƒë·ªô v√†o m·∫£ng

                // T·∫°o graphic cho ƒëi·ªÉm m·ªõi click
                var pointGraphic = new Graphic({
                    geometry: {
                        type: "point",
                        longitude: longitude,
                        latitude: latitude
                    },
                    symbol: {
                        type: "simple-marker",
                        color: [0, 150, 136], // M√†u xanh ng·ªçc
                        size: 8,
                        outline: {
                            color: [255, 255, 255],
                            width: 1
                        }
                    },
                    popupTemplate: {
                        title: "ƒêi·ªÉm ƒë√£ ch·ªçn",
                        content: `Vƒ© ƒë·ªô: ${latitude.toFixed(6)}<br>Kinh ƒë·ªô: ${longitude.toFixed(6)}`
                    }
                });
                clickGraphicsLayer.add(pointGraphic); // Th√™m v√†o layer ri√™ng
                clickedGraphics.push(pointGraphic); // L∆∞u graphic ƒë·ªÉ c√≥ th·ªÉ x√≥a sau

                updateCoordinateOutput(); // C·∫≠p nh·∫≠t hi·ªÉn th·ªã JSON
            });

            // H√†m ƒë·ªÉ c·∫≠p nh·∫≠t n·ªôi dung hi·ªÉn th·ªã JSON (v√† log ra console)
            function updateCoordinateOutput() {
                var jsonString = JSON.stringify(clickedCoordinates, null, 2); // ƒê·ªãnh d·∫°ng JSON ƒë·∫πp h∆°n

                // Log ra console
                console.log("Current Coordinates (JSON):");
                console.log(jsonString);

                // C·∫≠p nh·∫≠t hi·ªÉn th·ªã tr√™n trang HTML (n·∫øu c√≥ div output)
                var outputDiv = document.getElementById("coordinateOutput");
                if (outputDiv) {
                    outputDiv.textContent = jsonString;
                } else {
                    console.warn("Element with id 'coordinateOutput' not found. Coordinates will only be logged to console.");
                }
            }

            // --- N√∫t ƒë·ªÉ x√≥a t·∫•t c·∫£ c√°c ƒëi·ªÉm ƒë√£ click v√† m·∫£ng t·ªça ƒë·ªô ---
            // ƒê·ª£i DOM load xong r·ªìi m·ªõi g√°n event
            document.addEventListener('DOMContentLoaded', function () {
                var clearButton = document.getElementById("clearButton");
                if (clearButton) { // Ki·ªÉm tra xem n√∫t c√≥ t·ªìn t·∫°i kh√¥ng
                    clearButton.addEventListener("click", function () {
                        clickedCoordinates = []; // X√≥a m·∫£ng t·ªça ƒë·ªô
                        clickGraphicsLayer.removeAll(); // X√≥a t·∫•t c·∫£ graphic tr√™n layer click
                        clickedGraphics = []; // X√≥a m·∫£ng graphic ƒë√£ l∆∞u
                        updateCoordinateOutput(); // C·∫≠p nh·∫≠t l·∫°i hi·ªÉn th·ªã (s·∫Ω log m·∫£ng r·ªóng)
                    });
                } else {
                    console.warn("Element with id 'clearButton' not found. Clear functionality will not be available.");
                }
            });

            // ========== UTILITY FUNCTIONS ==========

            // H√†m thay ƒë·ªïi icon cho point symbol
            function changePointIcon(iconType) {
                if (iconLibrary[iconType]) {
                    pointSymbol.url = iconLibrary[iconType];
                }
            }

            // H√†m t·∫°o graphic t·ª´ data
            function createGraphic(data) {
                return new Graphic({
                    geometry: data,
                    symbol: data.symbol,
                    attributes: data,
                    popupTemplate: data.popupTemplate
                });
            }

            // H√†m c·∫≠p nh·∫≠t center v√† zoom c·ªßa map
            function updateMapView(longitude, latitude, zoomLevel) {
                view.center = [longitude, latitude];
                view.zoom = zoomLevel || 15;
            }
        });
    </script>
</head>

<body>
    <div id="viewDiv"></div>

    <!-- Panel ƒëi·ªÅu khi·ªÉn cho ch·ª©c nƒÉng b·∫•m t·ªça ƒë·ªô -->
    <div id="controlPanel">
        <div class="control-title">üìç C√¥ng c·ª• b·∫•m t·ªça ƒë·ªô</div>
        <button id="clearButton">üóëÔ∏è X√≥a t·∫•t c·∫£ ƒëi·ªÉm</button>
        <div class="control-title">T·ªça ƒë·ªô ƒë√£ ch·ªçn (JSON):</div>
        <div id="coordinateOutput">[]</div>
    </div>
</body>

</html>
